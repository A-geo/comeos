<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>Leaflet Fullscreen</title>
		<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
		<script src='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.js'></script>
		<script src="jquery-2.2.3.min.js"></script>
		<script src="jquery-csv.js"></script>
		<link href='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.css' rel='stylesheet' />
		<style>
			html, body, #map, .row-fluid{ height: 100%;}
			#map-wrapper { width: 80%; height: 80%; position: relative; border: 1px solid black; left: 10%; top: 10%}
			#map {width: 100%; height: 100%; background-color: white;}
			#button-wrapper { position: absolute; top: 10px; right: 10px; width: 200px; border: 1px solid black; background-color: white; padding-bottom: 10px}
			#legend-table { width: 120px; height: 30px; text-align: center; margin-top: 20px; margin-left:40px; border: 1px solid black } 
			.btnStyle { border-radius: 15px; background-color: #4D90FE;  border: 1px solid #3079ED; color: #FFFFFF; width: 150px; height: 30px; text-align: center; margin-top: 10px; margin-left:25px; font-family: Garamond; font-size: 15px}
			.legend-text {font-family: Garamond; font-size: 15px; font-weight: bold}
			.box{ width:40px; height:20px; border: 1px solid black}
			.light {background: #B6EDF0}
			.middle {background: #5CA3E6}
			.dark {background: #090991}
			
		</style>
	</head>

	<body>
		<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
		<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
		
		<div class="span9" style="height:100%">
			<div id="map-wrapper">
				<div id="map"></div>
				<div id="button-wrapper">
					<form class="form-control">
						<input type="range" id="DensitySlider" min="0" max="100000" step="1000" class="btnStyle">
						<input type="button" id="DensityShow" class="btnStyle" value="50,000 parcels per day" /> 
					</form>
					<form class="form-control" >
						<input type="range" id="RadiusSlider" min="0" max="200" step="10" class="btnStyle" value=50>
						<input type="button" id="RadiusShow" class="btnStyle" value="Radius: 50km" /> 
						<input type="button" value="Reset" id="Btn2" class="btnStyle" onclick = "resetMap()" /> 
					</form>
					<table id="legend-table">
					  <tr>
						<td><div class="box light"/></td>
						<td><div class = "legend-text"><€3/stop</div></td> 
					  </tr>
					  <tr>
						<td><div class="box middle"/></td>
						<td><div class = "legend-text">€3-5/stop</div></td> 
					  </tr>
					  <tr>
						<td><div class="box dark"/></td>
						<td><div class = "legend-text">>€5/stop</div></td> 
					  </tr>
					</table>
				</div>
			</div>
		</div>
	


		<script>
		
			
			//Global variables
			var geoJson;
			L.mapbox.accessToken = 'pk.eyJ1Ijoiam9yaXNiIiwiYSI6ImNpbHUxMGtkcjAwNTR1am00NHQydDFhMjMifQ.0WurDht28F5Xw4Bb_LlZlQ';
			var map = L.mapbox.map('map', 'mapbox.light')
			
			//init variables
			var radius = 50;
			var nmbrParcels = 50000;
			var totalDeliveries = 0;
			var filePath = '/comeos/zipcodes_centroids_BE.csv';
			var latMarker;
			var lonMarker;
			//arrays for containing zipdata
			var zipdata;
			var zipsInRadius = new Array();
			
			//Cost variables
			C1 = 1.3; //Distance
			C2 = 0.7; //Time
			C3 = 32.5; //Van
			
			//Only offline; initialise zipcode points
			/*
			var zip1 = { Deliveries:"2909",Failed:"289",Zipcode:"2000",x_centroid:"4.3970156",y_centroid:"51.214016",Area:"5.98559",Dist:"", Price:"" };
			var zip2 = { Deliveries:"1980",Failed:"245",Zipcode:"2018",x_centroid:"4.4165101",y_centroid:"51.2059669",Area:"3.692569",Dist:"",Price:"" };
			var zip3 = { Deliveries:"828",Failed:"154",Zipcode:"2060",x_centroid:"4.4278717",y_centroid:"51.2275772",Area:"3.015491",Dist:"",Price:"" };
			var zip4 = { Deliveries:"909",Failed:"110",Zipcode:"2140",x_centroid:"4.4450879",y_centroid:"51.2114944",Area:"3.807113",Dist:"",Price:"" };
			zipdata = [zip1,zip2,zip3,zip4]
			*/
			
			//initialize before loading, online
			map.on('load', function() {
				
				//On server
				
				$.get(filePath,function(data){
				processData(data);
				});
				
			});
			
			//Prevent zooming on when double clicking
			map.doubleClickZoom.disable(); 
			
			//to read csv, only used online
			function processData(csv) {
				zipdata = $.csv.toObjects(csv)
			}

			//now maps get really loaded
			map.setView([50.64111, 4.668056], 9);

			//catch dblclick on map
			map.on('dblclick', whenClicked);
			
			//catch dblclick on geojson layer
			function onEachFeature(feature, layer) {
				//bind click
				layer.on('dblclick', whenClicked);		
			}
			
			//actions when dblclicked: create marker + calculate prices
			function whenClicked(e) {
				//check if marker exists
				if (typeof marker !== 'undefined') {
					// the marker is defined
					map.removeLayer(marker)
				}
				
				lonMarker = e.latlng.lng;
				latMarker = e.latlng.lat;
				//create marker
				marker = new L.Marker([e.latlng.lat, e.latlng.lng]);
				map.addLayer(marker);
				marker.bindPopup("Distribution facility");
				//find zips in radius
				findZipsInRadius(); 
			}

			
			//find zipcodes within radius, call functions for price calculation and styling
			function findZipsInRadius() {
				totalDeliveries = 0;
				zipsInRadius = [];
				
				zipdata.forEach( function (arrayItem)
				{
					dist = distance(latMarker,lonMarker,arrayItem.y_centroid,arrayItem.x_centroid);
					if (dist < radius){
						//calculate new density here, assign it features in map -> make function for it
						arrayItem.Dist = dist;
						zipsInRadius.push(arrayItem);
						totalDeliveries = totalDeliveries + parseInt(arrayItem.Deliveries);
						//str = "distance to " + arrayItem.Zipcode + " is " + dist.toString();
						//console.log(str);
					}
					else {
						arrayItem.Price = 0;
					}
					
				});
				
				recalculateDensity();
				restyleLayer('color');
			}
			
			
			//calculate new density
			function recalculateDensity() {
			
				//calculate new cost and change it in the array.
				zipsInRadius.forEach( function (arrayItem)
				{
				
				  var densityShare = parseInt(arrayItem.Deliveries) / totalDeliveries;
				  var newNmbrPcls = densityShare * nmbrParcels;
				  newNmbrPcls = Math.ceil(newNmbrPcls);
				  var lineHaul = arrayItem.Dist * C1;
				  var lastMile = Math.sqrt(newNmbrPcls*arrayItem.Area) * C1 + newNmbrPcls*C2;
				  var vehicleCost = (C3 * newNmbrPcls) / 100;
				  var pctFailed = arrayItem.Failed/arrayItem.Deliveries;
				  var totalcost = (lineHaul+lastMile+vehicleCost) / (newNmbrPcls * (1-pctFailed));
				  arrayItem.Price = totalcost; 
				
				});
			
			}
			
			function restyleLayer(whatToDo) {
				
				if (whatToDo == 'color') {
					geoJson.eachLayer(function(featureInstanceLayer) { //loop through each polygon
					
						propertyValue = featureInstanceLayer.feature.properties.POSTCODE;

						// Your function that determines a fill color for a particular
						// property name and value.
						var myFillColor = getColorViaZipArray(propertyValue);
						if (myFillColor == "#BBC2C4"){ //grey zones, outside circle
							featureInstanceLayer.setStyle({
									fillColor: myFillColor,
									weight: 1,
									opacity: 0.2,
									color: 'white',
									dashArray: '1',
									fillOpacity: 0.4
								});
						}
						else {
						
							featureInstanceLayer.setStyle({
								fillColor: myFillColor,
								weight: 2,
								opacity: 1,
								color: 'white',
								dashArray: '3',
								fillOpacity: 0.5
							});
						}
					});
				}
				//when resetting layer, everyting to gray
				else if (whatToDo == 'reset') {
					geoJson.eachLayer(function(featureInstanceLayer) { //loop through each polygon
						featureInstanceLayer.setStyle({
							fillColor: '#BBC2C4',
							weight: 1,
							opacity: 0.2,
							color: 'white',
							dashArray: '1',
							fillOpacity: 0.4
						});
					});
				}
			
			}
				
			function getColorViaZipArray(zipCode) {
				var result = $.grep(zipdata, function(e){ return e.Zipcode == zipCode; });
				if (result[0].Price != 0){
					return getColor(result[0].Price);
				}
				else {
					return "#BBC2C4";//outside radius
				}
			}			
				
			//calculate distance between two lat lon points
			function distance(lat1, lon1, lat2, lon2) {
				var p = 0.017453292519943295;    // Math.PI / 180
				var c = Math.cos;
				var a = 0.5 - c((lat2 - lat1) * p)/2 + 
					  c(lat1 * p) * c(lat2 * p) * 
					  (1 - c((lon2 - lon1) * p))/2;

				return 12742 * Math.asin(Math.sqrt(a)); // 2 * R; R = 6371 km
			}
			
			
			//define color depending on feature property
			function getColor(d) {
				if (d<3) {
					return '#B6EDF0';
					}
				else if (d<5) {
					return '#5CA3E6';
					}
				else{
					return '#090991';
					}
			}

			//Style when loading zipcodes -> all grey
			function style(feature) {
				return {
					fillColor: "#BBC2C4",
					weight: 1,
					opacity: 0.2,
					color: 'white',
					dashArray: '1',
					fillOpacity: 0.4
				};
			}
			
			function resetMap() {
			
				//Delete marker
				//check if marker exists
				if (typeof marker !== 'undefined') {
					// the marker is defined
					map.removeLayer(marker)
				}
				//reset style to default
				restyleLayer('reset');
			
			}
			
			function setRadius() {
			//set radius of deliveries
				var str1 = "Radius: ";
				var straal = document.getElementById('RadiusSlider').value;
				radius = straal;
				str1 = str1 + Number(straal) + "km"
				document.getElementById('RadiusShow').value = str1;
				findZipsInRadius();			
			}
			
			function setDensity() {
				//set density of deliveries, multiply number
				var str1 = " parcels per day";
				var density = document.getElementById('DensitySlider').value;
				nmbrParcels = density;
				str1 = Number(density).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",").concat(str1);
				document.getElementById('DensityShow').value = str1;
				//recalculate density for each zipCode
				recalculateDensity();
			}			

			//catch slider change density
			$("#RadiusSlider").on("input change", function() { setRadius(); });
			
			//catch slider change radius
			$("#DensitySlider").on("input change", function() { setDensity(); });
			

			 // load GeoJSON from an external file
			 $.getJSON('/comeos/zipcodes_be.geojson',function(data){
				// add GeoJSON layer to the map once the file is loaded
				geoJson = L.geoJson(data,{style: style, onEachFeature:onEachFeature}).addTo(map);
			});

			//add fullscreen button to map
			L.control.fullscreen().addTo(map);

		</script>
	</body>
</html>